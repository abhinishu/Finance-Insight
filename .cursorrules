# Finance-Insight Project Rules & Standards

## 1. Core Mathematical Integrity
- **The Golden Equation**: Always ensure that `Natural GL Baseline = Adjusted P&L + Reconciliation Plug`.
- **Waterfall Logic**: Calculations must be "Bottom-Up." Parent nodes must always sum the `Adjusted P&L` values of their direct children.
- **Precision**: All financial calculations must use the `Decimal` type (not float) to avoid rounding errors.
  - **MANDATORY**: Use `from decimal import Decimal` for all financial values (PnL, amounts, measures)
  - **FORBIDDEN**: Never use `float()` in calculation paths, aggregation, or arithmetic operations
  - **EXCEPTION**: Converting Decimal to float is ONLY allowed at API boundaries (JSON serialization) or JSONB storage, with explicit comments explaining why
  - **Database**: Use `Numeric(18, 2)` in SQLAlchemy models, never `Float`
  - **Conversion Pattern**: `Decimal(str(value))` when loading from DB, `round(float(decimal_value), 4)` only for JSONB storage

## 2. Logic Abstraction (GenAI Safety)
- **The "Glass Box" Pattern**: Never allow Gemini to generate raw SQL directly. 
- **Translation Pipeline**: Natural Language -> JSON Predicate -> Schema Validation -> Parameterized SQL WHERE clause.
- **Auditability**: Every rule must store three states: `logic_en` (English), `predicate_json` (Intermediate), and `sql_where` (Final).

## 3. UI & UX Consistency
- **Configuration Driven**: The dimensions and measures selected in Tab 1 (Report Registration) must act as the "Source of Truth" for Tabs 2, 3, and 4.
- **Unified Tree**: Tabs 2 and 3 must use the exact same AG-Grid tree component and share expansion/selection states.
- **Visual Cues**: Any node in a tree with an active business rule must be highlighted and display a "Rule" icon (fx).

## 4. Coding Standards (FastAPI & React)
- **Backend**: Use Pydantic V2 for all schemas. Ensure all API responses include clear error messages and logging.
- **Frontend**: Use AG-Grid for all hierarchical data. Implement optional chaining (e.g., `node.rule?.logic_en`) to prevent runtime crashes when data is missing.
- **Resilience**: Implement exponential backoff for Gemini API calls using the `tenacity` library to handle 429 Rate Limit errors gracefully.

## 5. Data Handling
- **Mock Data**: When reseeding, ensure `MTD`, `WTD`, and `YTD` values are mathematically consistent with the generated `Daily P&L`.
- **Persistence**: Save calculation results to `fact_calculated_results` so they can be retrieved without re-running the waterfall engine.
